# 9. íŠ¸ëŸ¬ë¸”ìŠˆíŒ… & ë¬¸ì œ í•´ê²°

## Q9-1. ë¡œê·¸ì¸ ì‹œ N+1 ë¬¸ì œë¥¼ ì–´ë–»ê²Œ í•´ê²°í–ˆë‚˜ìš”?

### ë‹µë³€ í¬ì¸íŠ¸
- **ë¬¸ì œ**: ë¡œê·¸ì¸ ì‹œ ì±„íŒ…ë°© ëª©ë¡ ì¡°íšŒ ê³¼ì •ì—ì„œ N+1 ë¬¸ì œ ë°œìƒ
- **í•´ê²°**: ë°°ì¹˜ ì¡°íšŒ íŒ¨í„´, Fetch Join, ìµœì‹  ë©”ì‹œì§€ë§Œ ì¡°íšŒ
- **ê²°ê³¼**: ì¿¼ë¦¬ ìˆ˜ 21ê°œ â†’ 4ê°œ (80.95% ê°ì†Œ)

### ìƒì„¸ ë‹µë³€

#### 1. ë¬¸ì œ ìƒí™©
**ìœ„ì¹˜**: `domain/chat/service/ChatMessageService.java` (ìµœì í™” ì „)

**Before ìµœì í™”**:
```
ë¡œê·¸ì¸ ì„±ê³µ
  â†“
ì‚¬ìš©ìì˜ ì±„íŒ…ë°© ëª©ë¡ ì¡°íšŒ: 1ê°œ ì¿¼ë¦¬
  â†“
ê° ì±„íŒ…ë°©ì˜ ì°¸ì—¬ì ì¡°íšŒ: 10ê°œ ì¿¼ë¦¬ (N+1)
  â†“
ê° ì±„íŒ…ë°©ì˜ ìµœì‹  ë©”ì‹œì§€ ì¡°íšŒ: 10ê°œ ì¿¼ë¦¬ (N+1)
  â†“
ì´ 21ê°œ ì¿¼ë¦¬
```

#### 2. í•´ê²° ë°©ë²•

##### 2-1. Fetch Joinìœ¼ë¡œ ì°¸ì—¬ì ì •ë³´ ì¡°íšŒ
**ìœ„ì¹˜**: `domain/chat/repository/ConversationRepository.java`

**ì½”ë“œ ì˜ˆì‹œ**:
```java
// domain/chat/repository/ConversationRepository.java
@Query("SELECT DISTINCT c FROM Conversation c " +
       "JOIN FETCH c.participants p " +
       "WHERE p.user.idx = :userId AND p.status = 'ACTIVE'")
List<Conversation> findByUserId(@Param("userId") Long userId);
```

**íš¨ê³¼**: 10ê°œ ì¿¼ë¦¬ â†’ 1ê°œ ì¿¼ë¦¬

##### 2-2. ë°°ì¹˜ ì¡°íšŒë¡œ ìµœì‹  ë©”ì‹œì§€ ì¡°íšŒ
**ìœ„ì¹˜**: `domain/chat/service/ChatMessageService.java`

**ì „ì²´ íë¦„**:
```
ì±„íŒ…ë°© ëª©ë¡ ì¡°íšŒ ì™„ë£Œ
  â†“
ì±„íŒ…ë°© ID ë¦¬ìŠ¤íŠ¸ ì¶”ì¶œ
  â†“
IN ì ˆë¡œ ìµœì‹  ë©”ì‹œì§€ ë°°ì¹˜ ì¡°íšŒ
  â†“
1ê°œ ì¿¼ë¦¬ë¡œ ëª¨ë“  ìµœì‹  ë©”ì‹œì§€ ì¡°íšŒ
```

**ì½”ë“œ ì˜ˆì‹œ**:
```java
// domain/chat/service/ChatMessageService.java
List<Long> conversationIds = conversations.stream()
    .map(Conversation::getIdx)
    .collect(Collectors.toList());

// ë°°ì¹˜ ì¡°íšŒ: ìµœì‹  ë©”ì‹œì§€
Map<Long, ChatMessage> latestMessagesMap = chatMessageRepository
    .findLatestMessagesByConversationIds(conversationIds)
    .stream()
    .collect(Collectors.toMap(
        msg -> msg.getConversation().getIdx(),
        msg -> msg
    ));
```

**íš¨ê³¼**: 10ê°œ ì¿¼ë¦¬ â†’ 1ê°œ ì¿¼ë¦¬

##### 2-3. ì½ì§€ ì•Šì€ ë©”ì‹œì§€ ìˆ˜ ë°°ì¹˜ ì¡°íšŒ
**ìœ„ì¹˜**: `domain/chat/repository/ConversationParticipantRepository.java`

**ì½”ë“œ ì˜ˆì‹œ**:
```java
// ë°°ì¹˜ ì¡°íšŒ: ì½ì§€ ì•Šì€ ë©”ì‹œì§€ ìˆ˜
Map<Long, Integer> unreadCountMap = participantRepository
    .findUnreadCountsByConversationIds(conversationIds, userId)
    .stream()
    .collect(Collectors.toMap(
        ConversationParticipant::getConversationIdx,
        ConversationParticipant::getUnreadCount
    ));
```

**íš¨ê³¼**: 10ê°œ ì¿¼ë¦¬ â†’ 1ê°œ ì¿¼ë¦¬

#### 3. ìµœì¢… ê²°ê³¼
**After ìµœì í™”**:
```
1. ì±„íŒ…ë°© + ì°¸ì—¬ì ì¡°íšŒ (Fetch Join): 1ê°œ ì¿¼ë¦¬
2. ìµœì‹  ë©”ì‹œì§€ ë°°ì¹˜ ì¡°íšŒ: 1ê°œ ì¿¼ë¦¬
3. ì½ì§€ ì•Šì€ ë©”ì‹œì§€ ìˆ˜ ë°°ì¹˜ ì¡°íšŒ: 1ê°œ ì¿¼ë¦¬
4. ì‚¬ìš©ì ì •ë³´ ì¡°íšŒ: 1ê°œ ì¿¼ë¦¬

ì´ 4ê°œ ì¿¼ë¦¬
```

**ì„±ëŠ¥ ê°œì„ **:
- ì¿¼ë¦¬ ìˆ˜: 21ê°œ â†’ 4ê°œ (**80.95% ê°ì†Œ**)

---

## Q9-2. ì œì¬ ì‹œìŠ¤í…œ ë™ì‹œì„± ë¬¸ì œë¥¼ ì–´ë–»ê²Œ í•´ê²°í–ˆë‚˜ìš”?

### ë‹µë³€ í¬ì¸íŠ¸
- **ë¬¸ì œ**: ì—¬ëŸ¬ ê´€ë¦¬ìê°€ ë™ì‹œì— ê²½ê³  ë¶€ì—¬ ì‹œ Lost Update ë°œìƒ
- **í•´ê²°**: DB ë ˆë²¨ì—ì„œ ì›ìì  ì¦ê°€ ì¿¼ë¦¬ ì‚¬ìš©
- **íš¨ê³¼**: ê²½ê³  íšŸìˆ˜ê°€ ì •í™•í•˜ê²Œ ì¦ê°€í•˜ë©°, ìë™ ì´ìš©ì œí•œì´ ì •í™•íˆ í•œ ë²ˆë§Œ ì ìš©

### ìƒì„¸ ë‹µë³€

#### 1. ë¬¸ì œ ìƒí™©
**ì‹œë‚˜ë¦¬ì˜¤**: ê´€ë¦¬ì Aì™€ Bê°€ ë™ì‹œì— ê°™ì€ ì‚¬ìš©ìì—ê²Œ ê²½ê³  ë¶€ì—¬

**Before í•´ê²°**:
```
ì‹œê°„ T1: ê´€ë¦¬ì Aê°€ warningCount ì½ê¸° (í˜„ì¬: 2)
ì‹œê°„ T2: ê´€ë¦¬ì Bê°€ warningCount ì½ê¸° (í˜„ì¬: 2)
ì‹œê°„ T3: ê´€ë¦¬ì Aê°€ warningCount = 3ìœ¼ë¡œ ì €ì¥
ì‹œê°„ T4: ê´€ë¦¬ì Bê°€ warningCount = 3ìœ¼ë¡œ ì €ì¥

ê²°ê³¼: warningCount = 3 (ì‹¤ì œë¡œëŠ” 4ê°€ ë˜ì–´ì•¼ í•¨)
```

**ë¬¸ì œì **:
- Lost Update ë°œìƒ
- ê²½ê³  íšŸìˆ˜ ëˆ„ë½
- ìë™ ì´ìš©ì œí•œ ë¯¸ì ìš© ë˜ëŠ” ì¤‘ë³µ ì ìš©

#### 2. í•´ê²° ë°©ë²•
**ìœ„ì¹˜**: `domain/user/repository/SpringDataJpaUsersRepository.java`
**ë©”ì„œë“œ**: `incrementWarningCount()`

**ì½”ë“œ ì˜ˆì‹œ**:
```java
// domain/user/repository/SpringDataJpaUsersRepository.java
@Modifying
@Query("UPDATE Users u SET u.warningCount = u.warningCount + 1 WHERE u.idx = :userId")
int incrementWarningCount(@Param("userId") Long userId);
```

**ì‚¬ìš© ì˜ˆì‹œ**:
```java
// domain/user/service/UserSanctionService.java
@Transactional
public UserSanction addWarning(Long userId, String reason, Long adminId, Long reportId) {
    // ê²½ê³  ì¶”ê°€
    UserSanction warning = UserSanction.builder()
        .user(user)
        .sanctionType(UserSanction.SanctionType.WARNING)
        .reason(reason)
        .build();
    sanctionRepository.save(warning);
    
    // ê²½ê³  íšŸìˆ˜ ì›ìì  ì¦ê°€ (ë™ì‹œì„± ë¬¸ì œ í•´ê²°)
    usersRepository.incrementWarningCount(userId);
    
    // ì—…ë°ì´íŠ¸ëœ ì‚¬ìš©ì ì •ë³´ ë‹¤ì‹œ ì¡°íšŒ
    user = usersRepository.findById(userId).orElseThrow();
    
    // ê²½ê³  3íšŒ ì´ìƒì´ë©´ ìë™ ì´ìš©ì œí•œ
    if (user.getWarningCount() >= WARNING_THRESHOLD) {
        addSuspension(userId, "ê²½ê³  ëˆ„ì ìœ¼ë¡œ ì¸í•œ ìë™ ì´ìš©ì œí•œ", adminId, reportId, 3);
    }
    
    return warning;
}
```

#### 3. ë™ì‘ ì›ë¦¬
**DB ë ˆë²¨ ì›ìì„±**:
```
UPDATE users SET warning_count = warning_count + 1 WHERE idx = ?
```

- DB ì—”ì§„ì´ ë‚´ë¶€ì ìœ¼ë¡œ ë½ ê´€ë¦¬
- ì—¬ëŸ¬ ìš”ì²­ì´ ë™ì‹œì— ë“¤ì–´ì™€ë„ ìˆœì°¨ ì²˜ë¦¬
- Lost Update ë¬¸ì œ ì™„ì „ í•´ê²°

#### 4. íš¨ê³¼
- ê²½ê³  íšŸìˆ˜ê°€ ì •í™•í•˜ê²Œ ì¦ê°€
- ìë™ ì´ìš©ì œí•œì´ ì •í™•íˆ í•œ ë²ˆë§Œ ì ìš©
- ì¶”ê°€ ë½ ë©”ì»¤ë‹ˆì¦˜ ë¶ˆí•„ìš”

---

## Q9-3. í«ì¼€ì–´ ìš”ì²­ í™•ì • ì‹œ Race Conditionì„ ì–´ë–»ê²Œ í•´ê²°í–ˆë‚˜ìš”?

### ë‹µë³€ í¬ì¸íŠ¸
- íŠ¸ëœì­ì…˜ ë‚´ì—ì„œ ìƒíƒœ í™•ì¸ ë° ë³€ê²½
- ì›ìì  ì—°ì‚°ìœ¼ë¡œ ì¤‘ë³µ í™•ì • ë°©ì§€
- DB ì œì•½ì¡°ê±´ í™œìš©

### ìƒì„¸ ë‹µë³€

#### 1. ë¬¸ì œ ìƒí™©
**ì‹œë‚˜ë¦¬ì˜¤**: í«ì¼€ì–´ ìš”ì²­ì— ë™ì‹œì— ì—¬ëŸ¬ ëª…ì´ í™•ì • ìš”ì²­

**Before í•´ê²°**:
```
ì‚¬ìš©ì A: ìš”ì²­ ìƒíƒœ í™•ì¸ (PENDING)
ì‚¬ìš©ì B: ìš”ì²­ ìƒíƒœ í™•ì¸ (PENDING)
ì‚¬ìš©ì A: ìƒíƒœ ë³€ê²½ (CONFIRMED)
ì‚¬ìš©ì B: ìƒíƒœ ë³€ê²½ (CONFIRMED) - ì¤‘ë³µ í™•ì •
```

#### 2. í•´ê²° ë°©ë²•
**ìœ„ì¹˜**: `domain/care/service/CareRequestService.java`

**ì „ì²´ íë¦„**:
```
í«ì¼€ì–´ í™•ì • ìš”ì²­
  â†“
@Transactional íŠ¸ëœì­ì…˜ ì‹œì‘
  â†“
ìš”ì²­ ìƒíƒœ í™•ì¸ (PENDINGë§Œ í—ˆìš©)
  â†“
ìƒíƒœ ë³€ê²½ (CONFIRMED)
  â†“
ì„œë¹„ìŠ¤ ì œê³µì ì—°ê²°
  â†“
íŠ¸ëœì­ì…˜ ì»¤ë°‹
```

**ì½”ë“œ ì˜ˆì‹œ**:
```java
// domain/care/service/CareRequestService.java
@Transactional
public CareRequestDTO confirmRequest(Long requestId, Long providerId) {
    CareRequest request = careRequestRepository.findById(requestId)
        .orElseThrow(() -> new IllegalArgumentException("ìš”ì²­ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."));
    
    // íŠ¸ëœì­ì…˜ ë‚´ì—ì„œ ìƒíƒœ í™•ì¸
    if (request.getStatus() != CareRequestStatus.PENDING) {
        throw new IllegalStateException("ì´ë¯¸ ì²˜ë¦¬ëœ ìš”ì²­ì…ë‹ˆë‹¤.");
    }
    
    Users provider = usersRepository.findById(providerId)
        .orElseThrow(() -> new IllegalArgumentException("ì„œë¹„ìŠ¤ ì œê³µìë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."));
    
    // ìƒíƒœ ë³€ê²½
    request.setStatus(CareRequestStatus.CONFIRMED);
    request.setProvider(provider);
    request.setConfirmedAt(LocalDateTime.now());
    
    careRequestRepository.save(request);
    
    return careRequestConverter.toDTO(request);
}
```

#### 3. íŠ¸ëœì­ì…˜ ê²©ë¦¬ ìˆ˜ì¤€
**ê¸°ë³¸ê°’**: READ_COMMITTED

**ë™ì‘ ë°©ì‹**:
- íŠ¸ëœì­ì…˜ Aê°€ ìƒíƒœ ë³€ê²½ ì¤‘ì¼ ë•Œ
- íŠ¸ëœì­ì…˜ BëŠ” ì»¤ë°‹ëœ ë°ì´í„°ë§Œ ì½ìŒ
- íŠ¸ëœì­ì…˜ A ì»¤ë°‹ í›„ íŠ¸ëœì­ì…˜ Bê°€ ì½ìœ¼ë©´ CONFIRMED ìƒíƒœ
- ì¤‘ë³µ í™•ì • ë°©ì§€

#### 4. íš¨ê³¼
- Race Condition ë°©ì§€
- ì¤‘ë³µ í™•ì • ë°©ì§€
- ë°ì´í„° ì¼ê´€ì„± ìœ ì§€

---

## Q9-4. ëª¨ì„ ì°¸ì—¬ ì‹œ ì¸ì› ì´ˆê³¼ ë¬¸ì œë¥¼ ì–´ë–»ê²Œ í•´ê²°í–ˆë‚˜ìš”?

### ë‹µë³€ í¬ì¸íŠ¸
- íŠ¸ëœì­ì…˜ ë‚´ì—ì„œ ì¸ì› ìˆ˜ í™•ì¸ ë° ì¦ê°€
- DB ì œì•½ì¡°ê±´ìœ¼ë¡œ ìµœëŒ€ ì¸ì› ì´ˆê³¼ ë°©ì§€
- Race Condition ë°©ì§€

### ìƒì„¸ ë‹µë³€

#### 1. ë¬¸ì œ ìƒí™©
**ì‹œë‚˜ë¦¬ì˜¤**: ëª¨ì„ ìµœëŒ€ ì¸ì› 10ëª…, í˜„ì¬ 9ëª…ì¼ ë•Œ ë™ì‹œì— 2ëª…ì´ ì°¸ì—¬

**Before í•´ê²°**:
```
ì‚¬ìš©ì A: í˜„ì¬ ì¸ì› í™•ì¸ (9ëª…)
ì‚¬ìš©ì B: í˜„ì¬ ì¸ì› í™•ì¸ (9ëª…)
ì‚¬ìš©ì A: ì°¸ì—¬ (10ëª…)
ì‚¬ìš©ì B: ì°¸ì—¬ (11ëª…) - ìµœëŒ€ ì¸ì› ì´ˆê³¼
```

#### 2. í•´ê²° ë°©ë²•
**ìœ„ì¹˜**: `domain/meetup/service/MeetupService.java`

**ì „ì²´ íë¦„**:
```
ëª¨ì„ ì°¸ì—¬ ìš”ì²­
  â†“
@Transactional íŠ¸ëœì­ì…˜ ì‹œì‘
  â†“
ëª¨ì„ ì •ë³´ ì¡°íšŒ
  â†“
ì¸ì› ìˆ˜ í™•ì¸ (ìµœëŒ€ ì¸ì› ì²´í¬)
  â†“
ì¸ì› ìˆ˜ ì¦ê°€
  â†“
ì°¸ì—¬ì ì¶”ê°€
  â†“
íŠ¸ëœì­ì…˜ ì»¤ë°‹
```

**ì½”ë“œ ì˜ˆì‹œ**:
```java
// domain/meetup/service/MeetupService.java
@Transactional
public void joinMeetup(Long meetupId, Long userId) {
    Meetup meetup = meetupRepository.findById(meetupId)
        .orElseThrow(() -> new IllegalArgumentException("ëª¨ì„ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."));
    
    Users user = usersRepository.findById(userId)
        .orElseThrow(() -> new IllegalArgumentException("ì‚¬ìš©ìë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."));
    
    // íŠ¸ëœì­ì…˜ ë‚´ì—ì„œ ì¸ì› ìˆ˜ í™•ì¸
    if (meetup.getCurrentParticipants() >= meetup.getMaxParticipants()) {
        throw new IllegalStateException("ëª¨ì„ ì¸ì›ì´ ê°€ë“ ì°¼ìŠµë‹ˆë‹¤.");
    }
    
    // ì´ë¯¸ ì°¸ì—¬ ì¤‘ì¸ì§€ í™•ì¸
    boolean alreadyJoined = meetupParticipantRepository
        .existsByMeetupIdxAndUserIdx(meetupId, userId);
    if (alreadyJoined) {
        throw new IllegalStateException("ì´ë¯¸ ì°¸ì—¬ ì¤‘ì¸ ëª¨ì„ì…ë‹ˆë‹¤.");
    }
    
    // ì¸ì› ìˆ˜ ì¦ê°€
    meetup.setCurrentParticipants(meetup.getCurrentParticipants() + 1);
    meetupRepository.save(meetup);
    
    // ì°¸ì—¬ì ì¶”ê°€
    MeetupParticipant participant = MeetupParticipant.builder()
        .meetup(meetup)
        .user(user)
        .build();
    meetupParticipantRepository.save(participant);
}
```

#### 3. ì¶”ê°€ ë³´í˜¸ ì¥ì¹˜
**DB ì œì•½ì¡°ê±´**:
```sql
-- ëª¨ì„ ì—”í‹°í‹°ì— CHECK ì œì•½ì¡°ê±´ (ì„ íƒì )
ALTER TABLE meetup 
ADD CONSTRAINT chk_participants 
CHECK (current_participants <= max_participants);
```

#### 4. íš¨ê³¼
- ìµœëŒ€ ì¸ì› ì´ˆê³¼ ë°©ì§€
- ë™ì‹œì„± ë¬¸ì œ í•´ê²°
- Race Condition ë°©ì§€

---

## ğŸ“ í•µì‹¬ ì •ë¦¬

### ë¡œê·¸ì¸ N+1 ë¬¸ì œ
- **Fetch Join**: ì±„íŒ…ë°© + ì°¸ì—¬ì í•¨ê»˜ ì¡°íšŒ
- **ë°°ì¹˜ ì¡°íšŒ**: ìµœì‹  ë©”ì‹œì§€, ì½ì§€ ì•Šì€ ìˆ˜ IN ì ˆ ì¡°íšŒ
- **ê²°ê³¼**: 21ê°œ â†’ 4ê°œ ì¿¼ë¦¬ (80.95% ê°ì†Œ)

### ì œì¬ ì‹œìŠ¤í…œ ë™ì‹œì„±
- **ì›ìì  ì¦ê°€ ì¿¼ë¦¬**: DB ë ˆë²¨ì—ì„œ ì²˜ë¦¬
- **ìœ„ì¹˜**: `UsersRepository.incrementWarningCount()`
- **íš¨ê³¼**: Lost Update ì™„ì „ í•´ê²°

### í«ì¼€ì–´ í™•ì • Race Condition
- **íŠ¸ëœì­ì…˜ ë‚´ í™•ì¸**: ìƒíƒœ í™•ì¸ ë° ë³€ê²½
- **ê²©ë¦¬ ìˆ˜ì¤€**: READ_COMMITTED
- **íš¨ê³¼**: ì¤‘ë³µ í™•ì • ë°©ì§€

### ëª¨ì„ ì°¸ì—¬ ì¸ì› ì´ˆê³¼
- **íŠ¸ëœì­ì…˜ ë‚´ í™•ì¸**: ì¸ì› ìˆ˜ í™•ì¸ ë° ì¦ê°€
- **DB ì œì•½ì¡°ê±´**: CHECK ì œì•½ì¡°ê±´ (ì„ íƒì )
- **íš¨ê³¼**: ìµœëŒ€ ì¸ì› ì´ˆê³¼ ë°©ì§€
