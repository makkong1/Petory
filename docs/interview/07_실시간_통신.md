# 7. ì‹¤ì‹œê°„ í†µì‹ 

## Q7-1. WebSocketê³¼ SSEì˜ ì°¨ì´ë¥¼ ì„¤ëª…í•´ì£¼ì„¸ìš”.

### ë‹µë³€ í¬ì¸íŠ¸
- **WebSocket**: ì–‘ë°©í–¥ í†µì‹ , STOMP í”„ë¡œí† ì½œ ì‚¬ìš©, ì±„íŒ…ì— í™œìš©
- **SSE**: ì„œë²„ â†’ í´ë¼ì´ì–¸íŠ¸ ë‹¨ë°©í–¥, EventSource API, ì•Œë¦¼ì— í™œìš©
- í”„ë¡œì íŠ¸ì—ì„œ WebSocketì€ ì±„íŒ…, SSEëŠ” ì•Œë¦¼ì— ì‚¬ìš©

### ìƒì„¸ ë‹µë³€

#### 1. WebSocket íŠ¹ì§•
**ìš©ë„**: ì‹¤ì‹œê°„ ì–‘ë°©í–¥ í†µì‹ 

**íŠ¹ì§•**:
- ì–‘ë°©í–¥ í†µì‹  (í´ë¼ì´ì–¸íŠ¸ â†” ì„œë²„)
- ì§€ì†ì ì¸ ì—°ê²° ìœ ì§€
- ë‚®ì€ ì§€ì—° ì‹œê°„
- STOMP í”„ë¡œí† ì½œ ì‚¬ìš©

**í”„ë¡œì íŠ¸ ì‚¬ìš©**: ì±„íŒ… ì‹œìŠ¤í…œ

#### 2. SSE íŠ¹ì§•
**ìš©ë„**: ì„œë²„ â†’ í´ë¼ì´ì–¸íŠ¸ ë‹¨ë°©í–¥ í†µì‹ 

**íŠ¹ì§•**:
- ë‹¨ë°©í–¥ í†µì‹  (ì„œë²„ â†’ í´ë¼ì´ì–¸íŠ¸)
- HTTP ê¸°ë°˜ (WebSocketë³´ë‹¤ ê°„ë‹¨)
- ìë™ ì¬ì—°ê²° ì§€ì›
- EventSource API ì‚¬ìš©

**í”„ë¡œì íŠ¸ ì‚¬ìš©**: ì•Œë¦¼ ì‹œìŠ¤í…œ

#### 3. ë¹„êµí‘œ

| í•­ëª© | WebSocket | SSE |
|------|-----------|-----|
| í†µì‹  ë°©í–¥ | ì–‘ë°©í–¥ | ë‹¨ë°©í–¥ (ì„œë²„â†’í´ë¼ì´ì–¸íŠ¸) |
| í”„ë¡œí† ì½œ | STOMP | HTTP |
| ì—°ê²° ìœ ì§€ | ì§€ì†ì  | ì§€ì†ì  |
| ì‚¬ìš© ìš©ë„ | ì±„íŒ… | ì•Œë¦¼ |
| êµ¬í˜„ ë³µì¡ë„ | ë†’ìŒ | ë‚®ìŒ |

---

## Q7-2. WebSocket(STOMP) ê¸°ë°˜ ì±„íŒ… ì‹œìŠ¤í…œì„ ì„¤ëª…í•´ì£¼ì„¸ìš”.

### ë‹µë³€ í¬ì¸íŠ¸
- STOMP í”„ë¡œí† ì½œë¡œ ë©”ì‹œì§€ ë¸Œë¡œì»¤ í™œìš©
- 1:1 ì±„íŒ…, ê·¸ë£¹ ì±„íŒ… ì§€ì›
- í«ì¼€ì–´/ëª¨ì„ ìƒì„± ì‹œ ì±„íŒ…ë°© ìë™ ì—°ë™
- ì½ìŒ ìƒíƒœ ê´€ë¦¬

### ìƒì„¸ ë‹µë³€

#### 1. WebSocket ì„¤ì •
**ìœ„ì¹˜**: `global/websocket/config/WebSocketConfig.java`

**ì „ì²´ íë¦„**:
```
WebSocket ì—°ê²° ìš”ì²­
  â†“
WebSocketConfig.registerStompEndpoints()
  â†“
ì—”ë“œí¬ì¸íŠ¸ ë“±ë¡ (/ws, /chat)
  â†“
ì¸ì¦ ì¸í„°ì…‰í„° ì¶”ê°€
  â†“
SockJS ì§€ì›
```

**ì½”ë“œ ì˜ˆì‹œ**:
```java
// global/websocket/config/WebSocketConfig.java
@Override
public void registerStompEndpoints(StompEndpointRegistry registry) {
    registry.addEndpoint("/ws", "/chat")
        .setAllowedOriginPatterns("*")
        .addInterceptors(authenticationInterceptor)
        .setHandshakeHandler(new WebSocketHandshakeHandler())
        .withSockJS();
}

@Override
public void configureMessageBroker(MessageBrokerRegistry registry) {
    // ì„œë²„ â†’ í´ë¼ì´ì–¸íŠ¸ (êµ¬ë… ê²½ë¡œ)
    registry.enableSimpleBroker("/topic", "/queue", "/user");
    
    // í´ë¼ì´ì–¸íŠ¸ â†’ ì„œë²„ (ì „ì†¡ ê²½ë¡œ)
    registry.setApplicationDestinationPrefixes("/app");
    
    // ì‚¬ìš©ìë³„ ê°œì¸ ë©”ì‹œì§€ í”„ë¦¬í”½ìŠ¤
    registry.setUserDestinationPrefix("/user");
}
```

#### 2. ì±„íŒ… ë©”ì‹œì§€ ì „ì†¡
**ìœ„ì¹˜**: `domain/chat/controller/ChatController.java`

**ì „ì²´ íë¦„**:
```
í´ë¼ì´ì–¸íŠ¸ ë©”ì‹œì§€ ì „ì†¡
  â†“
ChatController.sendMessage()
  â†“
ChatMessageService.saveMessage()
  â†“
ë©”ì‹œì§€ DB ì €ì¥
  â†“
SimpMessagingTemplateìœ¼ë¡œ êµ¬ë…ìì—ê²Œ ì „ì†¡
```

**ì½”ë“œ ì˜ˆì‹œ**:
```java
// domain/chat/controller/ChatController.java
@MessageMapping("/chat.send")
public void sendMessage(@Payload ChatMessageDTO messageDTO, Principal principal) {
    ChatMessage savedMessage = chatMessageService.saveMessage(
        messageDTO.getChatRoomId(),
        Long.parseLong(principal.getName()),
        messageDTO.getContent()
    );
    
    // êµ¬ë…ìì—ê²Œ ë©”ì‹œì§€ ì „ì†¡
    messagingTemplate.convertAndSend(
        "/topic/chatroom/" + messageDTO.getChatRoomId(),
        chatMessageConverter.toDTO(savedMessage)
    );
}
```

#### 3. ì±„íŒ…ë°© ìë™ ì—°ë™
**ìœ„ì¹˜**: `domain/care/service/CareRequestService.java`, `domain/meetup/service/MeetupService.java`

**ì „ì²´ íë¦„**:
```
í«ì¼€ì–´/ëª¨ì„ ìƒì„±
  â†“
CareRequestService.createCareRequest() / MeetupService.createMeetup()
  â†“
ChatRoomService.createChatRoom()
  â†“
ì±„íŒ…ë°© ìë™ ìƒì„± ë° ì—°ë™
```

**ì½”ë“œ ì˜ˆì‹œ**:
```java
// domain/care/service/CareRequestService.java
@Transactional
public CareRequestDTO createCareRequest(CareRequestDTO dto) {
    CareRequest careRequest = CareRequest.builder()
        .requester(requester)
        .pet(pet)
        .build();
    
    CareRequest saved = careRequestRepository.save(careRequest);
    
    // ì±„íŒ…ë°© ìë™ ìƒì„±
    ChatRoom chatRoom = chatRoomService.createChatRoom(
        saved.getIdx(),
        ChatRoomType.CARE_REQUEST
    );
    
    return careRequestConverter.toDTO(saved);
}
```

#### 4. ì½ìŒ ìƒíƒœ ê´€ë¦¬
**ìœ„ì¹˜**: `domain/chat/service/ChatMessageService.java`

**ì „ì²´ íë¦„**:
```
ë©”ì‹œì§€ ì¡°íšŒ
  â†“
ChatMessageService.markAsRead()
  â†“
ì½ìŒ ìƒíƒœ ì—…ë°ì´íŠ¸
  â†“
ì½ìŒ ìƒíƒœ ë³€ê²½ ì•Œë¦¼ ì „ì†¡
```

---

## Q7-3. SSE ê¸°ë°˜ ì•Œë¦¼ ì‹œìŠ¤í…œì„ ì„¤ëª…í•´ì£¼ì„¸ìš”.

### ë‹µë³€ í¬ì¸íŠ¸
- ì´ì¤‘ ì €ì¥ì†Œ ì „ëµ: Redis + MySQL
- Redisì— ìµœì‹  50ê°œ ì•Œë¦¼ ì €ì¥ (TTL 24ì‹œê°„)
- SSEë¡œ ì‹¤ì‹œê°„ ì•Œë¦¼ í‘¸ì‹œ
- ì½ìŒ ì²˜ë¦¬ ë° ì•Œë¦¼ ì´ë ¥ ê´€ë¦¬

### ìƒì„¸ ë‹µë³€

#### 1. SSE ì„¤ì •
**ìœ„ì¹˜**: `domain/notification/controller/NotificationController.java`

**ì „ì²´ íë¦„**:
```
SSE ì—°ê²° ìš”ì²­
  â†“
NotificationController.subscribe()
  â†“
SseEmitter ìƒì„±
  â†“
NotificationSseServiceì— ë“±ë¡
  â†“
ì—°ê²° ìœ ì§€ ë° ì•Œë¦¼ ì „ì†¡
```

**ì½”ë“œ ì˜ˆì‹œ**:
```java
// domain/notification/controller/NotificationController.java
@GetMapping(value = "/subscribe", produces = MediaType.TEXT_EVENT_STREAM_VALUE)
public SseEmitter subscribe(@RequestParam String token) {
    // í† í°ì—ì„œ ì‚¬ìš©ì ID ì¶”ì¶œ
    Long userId = jwtUtil.getIdFromToken(token);
    
    // SSE ì—°ê²° ìƒì„±
    SseEmitter emitter = new SseEmitter(Long.MAX_VALUE);
    
    // ì•Œë¦¼ ì„œë¹„ìŠ¤ì— ë“±ë¡
    notificationSseService.addEmitter(userId, emitter);
    
    // ì—°ê²° ì¢…ë£Œ ì‹œ ì •ë¦¬
    emitter.onCompletion(() -> notificationSseService.removeEmitter(userId, emitter));
    emitter.onTimeout(() -> notificationSseService.removeEmitter(userId, emitter));
    
    return emitter;
}
```

#### 2. ì´ì¤‘ ì €ì¥ì†Œ ì „ëµ
**ìœ„ì¹˜**: `domain/notification/service/NotificationService.java`

**ì „ì²´ íë¦„**:
```
ì•Œë¦¼ ìƒì„±
  â†“
MySQLì— ì €ì¥ (ì˜êµ¬ ì €ì¥)
  â†“
Redisì— ìµœì‹  50ê°œ ì €ì¥ (TTL 24ì‹œê°„)
  â†“
SSEë¡œ ì‹¤ì‹œê°„ ì „ì†¡
```

**ì½”ë“œ ì˜ˆì‹œ**:
```java
// domain/notification/service/NotificationService.java
@Transactional
public NotificationDTO createNotification(Long userId, NotificationType type, 
        String title, String content, Long relatedId, String relatedType) {
    
    // MySQLì— ì €ì¥
    Notification notification = Notification.builder()
        .user(user)
        .type(type)
        .title(title)
        .content(content)
        .build();
    Notification saved = notificationRepository.save(notification);
    
    NotificationDTO dto = notificationConverter.toDTO(saved);
    
    // Redisì— ì‹¤ì‹œê°„ ì•Œë¦¼ ì €ì¥ (ìµœì‹  ì•Œë¦¼ ëª©ë¡ ê´€ë¦¬)
    saveToRedis(userId, dto);
    
    // SSEë¥¼ í†µí•´ ì‹¤ì‹œê°„ ì•Œë¦¼ ì „ì†¡
    sseService.sendNotification(userId, dto);
    
    return dto;
}
```

#### 3. Redis ì €ì¥ ë¡œì§
**ìœ„ì¹˜**: `domain/notification/service/NotificationService.java`
**ë©”ì„œë“œ**: `saveToRedis()`

**ì „ì²´ íë¦„**:
```
ì•Œë¦¼ ìƒì„±
  â†“
Redisì—ì„œ ê¸°ì¡´ ì•Œë¦¼ ëª©ë¡ ì¡°íšŒ
  â†“
ìƒˆ ì•Œë¦¼ ì¶”ê°€
  â†“
ìµœì‹  50ê°œë§Œ ìœ ì§€
  â†“
TTL 24ì‹œê°„ ì„¤ì •
```

**ì½”ë“œ ì˜ˆì‹œ**:
```java
// domain/notification/service/NotificationService.java
private void saveToRedis(Long userId, NotificationDTO notification) {
    String key = REDIS_KEY_PREFIX + userId;
    
    // ê¸°ì¡´ ì•Œë¦¼ ëª©ë¡ ì¡°íšŒ
    List<NotificationDTO> notifications = getFromRedis(userId);
    if (notifications == null) {
        notifications = new ArrayList<>();
    }
    
    // ìƒˆ ì•Œë¦¼ ì¶”ê°€
    notifications.add(0, notification);
    
    // ìµœì‹  50ê°œë§Œ ìœ ì§€
    if (notifications.size() > 50) {
        notifications = notifications.subList(0, 50);
    }
    
    // Redisì— ì €ì¥ (TTL 24ì‹œê°„)
    notificationRedisTemplate.opsForValue().set(
        key, 
        notifications, 
        REDIS_TTL_HOURS, 
        TimeUnit.HOURS
    );
}
```

#### 4. SSE ì•Œë¦¼ ì „ì†¡
**ìœ„ì¹˜**: `domain/notification/service/NotificationSseService.java`

**ì „ì²´ íë¦„**:
```
ì•Œë¦¼ ìƒì„±
  â†“
NotificationSseService.sendNotification()
  â†“
í•´ë‹¹ ì‚¬ìš©ìì˜ SseEmitter ì¡°íšŒ
  â†“
ë©”ì‹œì§€ ì „ì†¡
  â†“
ì—°ê²° ëŠì–´ì¡Œìœ¼ë©´ ì œê±°
```

**ì½”ë“œ ì˜ˆì‹œ**:
```java
// domain/notification/service/NotificationSseService.java
public void sendNotification(Long userId, NotificationDTO notification) {
    SseEmitter emitter = emitters.get(userId);
    
    if (emitter != null) {
        try {
            emitter.send(SseEmitter.event()
                .name("notification")
                .data(notification));
        } catch (IOException e) {
            // ì—°ê²° ëŠì–´ì¡Œìœ¼ë©´ ì œê±°
            removeEmitter(userId, emitter);
        }
    }
}
```

---

## Q7-4. ì±„íŒ… ì½ìŒ ìƒíƒœë¥¼ ì–´ë–»ê²Œ ìµœì í™”í–ˆë‚˜ìš”?

### ë‹µë³€ í¬ì¸íŠ¸
- ë°°ì¹˜ ì¡°íšŒë¡œ ì½ìŒ ìƒíƒœ ì •ë³´ í•œ ë²ˆì— ì¡°íšŒ
- Redis ìºì‹± í™œìš©
- N+1 ë¬¸ì œ í•´ê²°

### ìƒì„¸ ë‹µë³€

#### 1. ì½ìŒ ìƒíƒœ ì¡°íšŒ ìµœì í™”
**ìœ„ì¹˜**: `domain/chat/service/ChatMessageService.java`

**Before ìµœì í™”**:
```
ê° ë©”ì‹œì§€ë§ˆë‹¤ ì½ìŒ ìƒíƒœ ì¡°íšŒ
  â†“
Nê°œ ì¿¼ë¦¬ ë°œìƒ
```

**After ìµœì í™”**:
```
ë©”ì‹œì§€ ID ë¦¬ìŠ¤íŠ¸ ì¶”ì¶œ
  â†“
IN ì ˆë¡œ ì½ìŒ ìƒíƒœ ë°°ì¹˜ ì¡°íšŒ
  â†“
1ê°œ ì¿¼ë¦¬ë¡œ ëª¨ë“  ì½ìŒ ìƒíƒœ ì¡°íšŒ
```

**ì½”ë“œ ì˜ˆì‹œ**:
```java
// domain/chat/service/ChatMessageService.java
public List<ChatMessageDTO> getMessages(Long chatRoomId, Long userId) {
    // ë©”ì‹œì§€ ì¡°íšŒ
    List<ChatMessage> messages = chatMessageRepository.findByChatRoomIdOrderByCreatedAtDesc(chatRoomId);
    
    // ë©”ì‹œì§€ ID ë¦¬ìŠ¤íŠ¸ ì¶”ì¶œ
    List<Long> messageIds = messages.stream()
        .map(ChatMessage::getIdx)
        .collect(Collectors.toList());
    
    // ë°°ì¹˜ ì¡°íšŒ: ì½ìŒ ìƒíƒœ
    Map<Long, Boolean> readStatusMap = chatReadStatusRepository
        .findByMessageIdxInAndUserId(messageIds, userId)
        .stream()
        .collect(Collectors.toMap(
            ChatReadStatus::getMessageIdx,
            ChatReadStatus::getIsRead
        ));
    
    // ë§¤í•‘
    return messages.stream()
        .map(message -> {
            ChatMessageDTO dto = chatMessageConverter.toDTO(message);
            dto.setIsRead(readStatusMap.getOrDefault(message.getIdx(), false));
            return dto;
        })
        .collect(Collectors.toList());
}
```

#### 2. Redis ìºì‹±
**ìœ„ì¹˜**: `domain/chat/service/ChatMessageService.java`

**ì „ì²´ íë¦„**:
```
ì½ìŒ ìƒíƒœ ì¡°íšŒ
  â†“
Redisì—ì„œ ë¨¼ì € ì¡°íšŒ ì‹œë„
  â†“
ìˆìœ¼ë©´: Redisì—ì„œ ë°˜í™˜
ì—†ìœ¼ë©´: DBì—ì„œ ì¡°íšŒ í›„ Redisì— ì €ì¥
```

**íš¨ê³¼**:
- ì¡°íšŒ ì„±ëŠ¥ í–¥ìƒ
- DB ë¶€í•˜ ê°ì†Œ

---

## ğŸ“ í•µì‹¬ ì •ë¦¬

### WebSocket vs SSE
- **WebSocket**: ì–‘ë°©í–¥, STOMP, ì±„íŒ…
- **SSE**: ë‹¨ë°©í–¥, HTTP, ì•Œë¦¼
- **ì„ íƒ ê¸°ì¤€**: í†µì‹  ë°©í–¥ê³¼ ìš©ë„ì— ë”°ë¼ ì„ íƒ

### WebSocket ì±„íŒ… ì‹œìŠ¤í…œ
- **ì„¤ì •**: WebSocketConfigì—ì„œ STOMP ì—”ë“œí¬ì¸íŠ¸ ë“±ë¡
- **ë©”ì‹œì§€ ì „ì†¡**: SimpMessagingTemplate ì‚¬ìš©
- **ìë™ ì—°ë™**: í«ì¼€ì–´/ëª¨ì„ ìƒì„± ì‹œ ì±„íŒ…ë°© ìë™ ìƒì„±
- **ì½ìŒ ìƒíƒœ**: ë°°ì¹˜ ì¡°íšŒë¡œ ìµœì í™”

### SSE ì•Œë¦¼ ì‹œìŠ¤í…œ
- **ì´ì¤‘ ì €ì¥ì†Œ**: MySQL (ì˜êµ¬) + Redis (ìµœì‹  50ê°œ)
- **TTL**: 24ì‹œê°„
- **ì‹¤ì‹œê°„ ì „ì†¡**: SseEmitterë¡œ í‘¸ì‹œ
- **íš¨ê³¼**: ë¹ ë¥¸ ì¡°íšŒ, ì‹¤ì‹œê°„ ì•Œë¦¼

### ì½ìŒ ìƒíƒœ ìµœì í™”
- **ë°°ì¹˜ ì¡°íšŒ**: IN ì ˆë¡œ í•œ ë²ˆì— ì¡°íšŒ
- **Redis ìºì‹±**: ìì£¼ ì¡°íšŒë˜ëŠ” ë°ì´í„° ìºì‹±
- **íš¨ê³¼**: N+1 ë¬¸ì œ í•´ê²°, ì„±ëŠ¥ í–¥ìƒ
