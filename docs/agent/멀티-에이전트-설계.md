# Petory 멀티 에이전트 설계

## 1. 개요

Petory에 **두 가지 에이전트**를 도입하는 방안을 정리한다.

| 구분 | 대상 | 에이전트 역할 | 연동 도메인 |
|------|------|----------------|-------------|
| **관리자** | 신고 처리 담당자 | 신고 보조(요약, 심각도·조치 제안) | Report |
| **사용자** | 일반 회원 | 주변 서비스 추천(맞춤 추천, 이유 설명) | Location |

- 에이전트는 **보조 역할**만 수행하며, 최종 결정·저장·제재는 기존 서비스가 담당한다.
- LLM은 **Ollama(로컬)** 로 연동한다. Spring Boot 내 에이전트 레이어에서 Spring AI를 통해 Ollama 채팅/완성 API를 호출한다.

### 1.1 LLM 연동: Ollama

- **제공 방식**: 로컬 Ollama 서버 (이미 설치된 환경 사용).
- **이점**: API 비용 없음, 데이터 외부 전송 없음, 개발/테스트에 유리.
- **연동**: Spring AI의 Ollama 채팅(또는 완성) 엔드포인트 사용. 기본 URL `http://localhost:11434` (설정으로 변경 가능).
- **모델**: Ollama에서 pull한 모델명(예: `llama3`, `gemma2`)을 설정으로 지정.

---

## 2. 에이전트 1: 관리자 신고 보조 (Report Assistant)

### 2.1 목적

- 관리자가 신고를 검토할 때 **요약·심각도·조치 유형**을 AI가 제안하여 검토 시간을 줄인다.
- **자동 처리가 아님**: 제안만 제공하고, 처리(handle)는 기존 `ReportService.handleReport()`로 관리자가 결정한다.

### 2.2 입력

- 신고 상세 정보(기존 `ReportDetailDTO` 활용):
  - `report`: 신고 사유(reason), 대상 타입(targetType), 상태 등
  - `target`: 대상 미리보기(title, summary, authorName)

### 2.3 에이전트 출력 (제안 DTO 예시)

```text
- summary: 신고 내용 한 줄 요약
- suggestedSeverity: LOW | MEDIUM | HIGH (심각도 제안)
- suggestedAction: NONE | DELETE_CONTENT | WARN_USER | SUSPEND_USER | OTHER (ReportActionType과 매핑)
- reasoning: 제안 이유 (관리자 참고용, 1~2문장)
```

### 2.4 연동 위치

- **API**: `GET /api/admin/reports/{id}/assist` 또는 기존 상세 API 응답에 `assist` 필드 포함
- **서비스**: `ReportService.getReportDetail(id)`로 상세 조회 후, **ReportAssistAgentService**(신규)에 전달 → LLM 호출 → 제안 반환
- **권한**: 기존과 동일하게 `@PreAuthorize("hasAnyRole('ADMIN','MASTER')")`

### 2.5 흐름

```text
[관리자] 신고 상세 요청
    → AdminReportController.getReportDetail(id)
    → ReportService.getReportDetail(id)
    → (선택) ReportAssistAgentService.getAssistSuggestions(detail)
    → ReportDetailDTO + assist 필드(제안) 반환
[관리자] 처리 시 기존대로 POST /api/admin/reports/{id}/handle
```

---

## 3. 에이전트 2: 사용자 주변 서비스 추천 (Nearby Recommendation)

### 3.1 목적

- 사용자 **위치·선호(카테고리/키워드)**를 반영해 **주변 서비스 추천 목록 + 추천 이유**를 제공한다.
- 기존 Location 검색 결과를 **에이전트가 재순위화·요약**하거나, “왜 이 장소를 추천했는지” 짧은 문장으로 붙일 수 있다.

### 3.2 입력

- 사용자 위치: `latitude`, `longitude`
- (선택) 반경 `radius`, 카테고리 `category`, 키워드 `keyword`
- (선택) 사용자 컨텍스트: 반려동물 크기, “병원/카페/공원” 등 선호(추후 확장)

### 3.3 에이전트 출력

- **옵션 A (단순)**: 기존 `LocationServiceService.searchLocationServicesByLocation()` 결과에 **추천 순서 재정렬 + 각 장소별 1줄 추천 이유** 추가
- **옵션 B (풀)**: 동일 검색 조건으로 후보 목록 조회 후, LLM이 “상위 N개 선택 + 이유” 반환

초기에는 **옵션 A** 권장(기존 검색 로직 유지, 에이전트는 순서·설명만 보조).

### 3.4 연동 위치

- **API**: `GET /api/location-services/recommend?latitude=...&longitude=...&radius=...&category=...`
- **서비스**: `LocationServiceService`로 후보 목록 조회 → **LocationRecommendAgentService**(신규)에 전달 → 재순위/이유 생성 → DTO에 `recommendReason` 등 필드 추가
- **권한**: 로그인 사용자 또는 비로그인 허용(정책에 따라 결정)

### 3.5 흐름

```text
[사용자] 주변 추천 요청
    → LocationServiceController.recommend() (신규 엔드포인트)
    → LocationServiceService 검색(기존 searchLocationServicesByLocation 활용)
    → LocationRecommendAgentService.enrichWithRecommendations(services, userContext)
    → List<LocationServiceDTO> + 각 DTO에 recommendationReason (선택) 반환
```

---

## 4. 공통 기술 구조 제안

### 4.1 패키지 구조

```text
domain/
  report/
    service/
      ReportService.java          # 기존
      ReportAssistAgentService.java  # 신규 (에이전트 1)
  location/
    service/
      LocationServiceService.java   # 기존
      LocationRecommendAgentService.java  # 신규 (에이전트 2)
  agent/   # (선택) 공통 에이전트 인터페이스/설정
    config/
    client/   # LLM 클라이언트 래퍼 (Spring AI 등)
```

- 에이전트 서비스는 **도메인 서비스만 호출**(Repository 직접 접근 지양).
- LLM 호출 실패 시: 제안/추천만 비우고 기존 동작(상세 조회, 검색 결과)은 그대로 반환하도록 fallback.

### 4.2 LLM 연동 (Ollama)

- **LLM**: **Ollama** (로컬). Spring AI의 Ollama 프로바이더로 채팅/완성 API 호출.
- **의존성**: `spring-ai-ollama` (Spring AI Ollama 스타터 또는 해당 모듈).
- **설정 예**: `spring.ai.ollama.base-url=http://localhost:11434`, `spring.ai.ollama.chat.options.model=llama3` (사용할 모델명은 환경에 맞게 지정).
- 필요 시 **LangChain4j**로 프롬프트/체인 관리 가능(선택).

### 4.3 비용·지연

- **신고 보조**: 신고 상세 열람 시 1회 호출 → 지연 허용 범위 넓음(1~3초).
- **주변 추천**: 목록 조회 시 1회 호출 → 캐싱(위치+반경+카테고리 키) 고려 권장.

---

## 5. 정리

| 항목 | 신고 보조 에이전트 | 주변 서비스 추천 에이전트 |
|------|--------------------|---------------------------|
| 사용자 | 관리자(ADMIN/MASTER) | 일반 사용자 |
| 입력 | ReportDetailDTO 수준 정보 | 위치 + 반경 + 카테고리/키워드 |
| 출력 | 요약, 심각도·조치 제안, 이유 | 추천 순서·이유(기존 검색 기반) |
| 기존 API | GET 상세 + (선택) /assist | GET /recommend (신규) |
| 기존 도메인 | Report, ReportService | Location, LocationServiceService |

이 설계대로 진행하면, 기존 **Report / Location 도메인과 Admin API**를 유지한 채 멀티 에이전트를 단계적으로 붙일 수 있다.
