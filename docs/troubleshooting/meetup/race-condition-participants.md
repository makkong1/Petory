# ëª¨ì„ ì°¸ê°€ ì‹œ Race Condition ë¬¸ì œ í•´ê²°

## ğŸ“‹ ìš”ì•½

**ë¬¸ì œ**: ë™ì‹œ ì°¸ê°€ ì‹œ ìµœëŒ€ ì¸ì› ì´ˆê³¼ (3ëª… ì œí•œì¸ë° 4ëª… ì°¸ê°€)

**í•´ê²°**: ì›ìì  UPDATE ì¿¼ë¦¬ ë°©ì‹ + DB ì œì•½ì¡°ê±´ ì ìš© + ì´ë²¤íŠ¸ ê¸°ë°˜ ì•„í‚¤í…ì²˜
- âœ… Race Condition ì™„ì „ í•´ê²°
- âœ… í”„ë¡œì íŠ¸ ì¼ê´€ì„± í™•ë³´ (Chat, User ë„ë©”ì¸ê³¼ ë™ì¼í•œ íŒ¨í„´)
- âœ… ë°ì´í„° ì •í•©ì„± 100% ë³´ì¥
- âœ… DB ë ˆë²¨ ì´ì¤‘ ì•ˆì „ì¥ì¹˜ (CHECK ì œì•½ì¡°ê±´)
- âœ… í•µì‹¬ ë„ë©”ì¸ê³¼ íŒŒìƒ ë„ë©”ì¸ ë¶„ë¦¬ (ì´ë²¤íŠ¸ ê¸°ë°˜)

---

## 1. ë¬¸ì œ ìƒí™©

### 1.1 ë°œìƒ ë°°ê²½

ëª¨ì„ ì°¸ê°€ ê¸°ëŠ¥ì—ì„œ ë™ì‹œì— ì—¬ëŸ¬ ì‚¬ìš©ìê°€ ì°¸ê°€ ë²„íŠ¼ì„ í´ë¦­í•  ë•Œ, ìµœëŒ€ ì¸ì›ì„ ì´ˆê³¼í•˜ì—¬ ì°¸ê°€ê°€ í—ˆìš©ë˜ëŠ” ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.

**ì‹œë‚˜ë¦¬ì˜¤ ì˜ˆì‹œ**:
- ëª¨ì„ ìµœëŒ€ ì¸ì›: 3ëª…
- ëª¨ì„ì¥ 1ëª… (ì´ë¯¸ ì°¸ê°€) â†’ `currentParticipants = 1`
- ë‚¨ì€ ìë¦¬: 2ëª…
- ë™ì‹œì— 3ëª…ì´ ì°¸ê°€ ë²„íŠ¼ í´ë¦­
- 3ëª… ëª¨ë‘ `currentParticipants (1) < maxParticipants (3)` ì²´í¬ í†µê³¼
- 3ëª… ëª¨ë‘ ì°¸ê°€ ì²˜ë¦¬
- **ê²°ê³¼**: `currentParticipants = 1 + 3 = 4ëª…` â†’ ìµœëŒ€ ì¸ì› ì´ˆê³¼!

### 1.2 ë¬¸ì œì 

#### Race Conditionìœ¼ë¡œ ì¸í•œ ë°ì´í„° ë¶ˆì¼ì¹˜
- **ì¦ìƒ**: ìµœëŒ€ ì¸ì›ì„ ì´ˆê³¼í•˜ì—¬ ì°¸ê°€ê°€ í—ˆìš©ë¨
- **ì›ì¸**: 
  - `currentParticipants` ì²´í¬ì™€ ì¦ê°€ ì‚¬ì´ì— ë‹¤ë¥¸ íŠ¸ëœì­ì…˜ì´ ë¼ì–´ë“¤ ìˆ˜ ìˆìŒ
  - `setCurrentParticipants(getCurrentParticipants() + 1)`ëŠ” ì›ìì  ì—°ì‚°ì´ ì•„ë‹˜
  - ë™ì‹œì— ì—¬ëŸ¬ ìš”ì²­ì´ ê°™ì€ ê°’ì„ ì½ê³  ì¦ê°€ì‹œì¼œ Lost Update ë°œìƒ
- **ì˜í–¥**: 
  - ëª¨ì„ ì¸ì› ê´€ë¦¬ ì‹¤íŒ¨
  - ì‚¬ìš©ì ì‹ ë¢°ë„ í•˜ë½
  - ìš´ì˜ìƒ ë¬¸ì œ ë°œìƒ ê°€ëŠ¥

### 1.3 Before (ë¬¸ì œ ì½”ë“œ)

```java
// MeetupService.joinMeetup() - ìµœì í™” ì „
@Transactional
public MeetupParticipantsDTO joinMeetup(Long meetupIdx, String userId) {
    Meetup meetup = meetupRepository.findById(meetupIdx)
            .orElseThrow(() -> new RuntimeException("ëª¨ì„ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."));

    // ... ì‚¬ìš©ì í™•ì¸ ë¡œì§ ...

    // âš ï¸ Race Condition ë°œìƒ ì§€ì 
    if (!meetup.getOrganizer().getIdx().equals(userIdx)) {
        // 1. í˜„ì¬ ì¸ì› ì½ê¸°
        if (meetup.getCurrentParticipants() >= meetup.getMaxParticipants()) {
            throw new RuntimeException("ëª¨ì„ ì¸ì›ì´ ê°€ë“ ì°¼ìŠµë‹ˆë‹¤.");
        }
        // 2. ì—¬ê¸°ì„œ ë‹¤ë¥¸ íŠ¸ëœì­ì…˜ì´ ë¼ì–´ë“¤ ìˆ˜ ìˆìŒ!
        // 3. ì¸ì› ì¦ê°€
        meetup.setCurrentParticipants(meetup.getCurrentParticipants() + 1);
        meetupRepository.save(meetup);
    }

    // ì°¸ê°€ì ì¶”ê°€
    MeetupParticipants participant = MeetupParticipants.builder()
            .meetup(meetup)
            .user(user)
            .joinedAt(LocalDateTime.now())
            .build();

    return participantsConverter.toDTO(meetupParticipantsRepository.save(participant));
}
```

### 1.4 ë¬¸ì œ ë°œìƒ ì‹œë‚˜ë¦¬ì˜¤

```
ì‹œê°„ | íŠ¸ëœì­ì…˜ A (ì‚¬ìš©ì1)              | íŠ¸ëœì­ì…˜ B (ì‚¬ìš©ì2)              | íŠ¸ëœì­ì…˜ C (ì‚¬ìš©ì3)              | DB ìƒíƒœ
-----|--------------------------------|--------------------------------|--------------------------------|----------
T1   | currentParticipants ì½ê¸° (1)   |                                 |                                 | 1
T2   |                                 | currentParticipants ì½ê¸° (1)   |                                 | 1
T3   |                                 |                                 | currentParticipants ì½ê¸° (1)   | 1
T4   | ì²´í¬: 1 < 3 í†µê³¼ âœ…             |                                 |                                 | 1
T5   |                                 | ì²´í¬: 1 < 3 í†µê³¼ âœ…             |                                 | 1
T6   |                                 |                                 | ì²´í¬: 1 < 3 í†µê³¼ âœ…             | 1
T7   | currentParticipants = 2 ì €ì¥   |                                 |                                 | 2
T8   | ì°¸ê°€ì ì¶”ê°€                     |                                 |                                 | 2
T9   | ì»¤ë°‹                            |                                 |                                 | 2
T10  |                                 | currentParticipants = 2 ì €ì¥   |                                 | 2 (Lost Update!)
T11  |                                 | ì°¸ê°€ì ì¶”ê°€                     |                                 | 2
T12  |                                 | ì»¤ë°‹                            |                                 | 2
T13  |                                 |                                 | currentParticipants = 2 ì €ì¥   | 2 (Lost Update!)
T14  |                                 |                                 | ì°¸ê°€ì ì¶”ê°€                     | 2
T15  |                                 |                                 | ì»¤ë°‹                            | 2
ê²°ê³¼: 3ëª… ëª¨ë‘ ì°¸ê°€ ì„±ê³µ, currentParticipants = 2 (ì‹¤ì œë¡œëŠ” 4ëª… ì°¸ê°€!)
```

---

## 2. í•´ê²° ë°©ë²•

### 2.1 ìµœì¢… ì ìš©: ì›ìì  UPDATE ì¿¼ë¦¬ ë°©ì‹

#### Repository ë©”ì„œë“œ ì¶”ê°€

```java
// MeetupRepository.java
@Modifying
@Query("UPDATE Meetup m SET m.currentParticipants = m.currentParticipants + 1 " +
       "WHERE m.idx = :meetupIdx " +
       "  AND m.currentParticipants < m.maxParticipants")
int incrementParticipantsIfAvailable(@Param("meetupIdx") Long meetupIdx);
```

#### Service ë¡œì§ ìˆ˜ì •

```java
// MeetupService.joinMeetup() - ì›ìì  UPDATE ì¿¼ë¦¬ ì ìš©
@Transactional
public MeetupParticipantsDTO joinMeetup(Long meetupIdx, String userId) {
    // ëª¨ì„ ì¡°íšŒ (Lock ì—†ì´)
    Meetup meetup = meetupRepository.findById(meetupIdx)
            .orElseThrow(() -> new RuntimeException("ëª¨ì„ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."));

    // ... ì‚¬ìš©ì í™•ì¸ ë¡œì§ ...

    // ì£¼ìµœìê°€ ì•„ë‹Œ ê²½ìš°ì—ë§Œ ì¸ì› ì¦ê°€ (ì›ìì  UPDATE ì¿¼ë¦¬)
    if (!meetup.getOrganizer().getIdx().equals(userIdx)) {
        // ì›ìì  UPDATE ì¿¼ë¦¬ë¡œ ì¡°ê±´ë¶€ ì¦ê°€ (DB ë ˆë²¨ì—ì„œ ì²´í¬ + ì¦ê°€ ë™ì‹œ ì²˜ë¦¬)
        int updated = meetupRepository.incrementParticipantsIfAvailable(meetupIdx);
        if (updated == 0) {
            throw new RuntimeException("ëª¨ì„ ì¸ì›ì´ ê°€ë“ ì°¼ìŠµë‹ˆë‹¤.");
        }
        // ì—…ë°ì´íŠ¸ëœ ëª¨ì„ ì •ë³´ ë‹¤ì‹œ ì¡°íšŒ
        meetup = meetupRepository.findById(meetupIdx)
                .orElseThrow(() -> new RuntimeException("ëª¨ì„ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."));
    }

    // ì°¸ê°€ì ì¶”ê°€
    MeetupParticipants participant = MeetupParticipants.builder()
            .meetup(meetup)
            .user(user)
            .joinedAt(LocalDateTime.now())
            .build();

    return participantsConverter.toDTO(meetupParticipantsRepository.save(participant));
}
```

#### ë™ì‘ ë°©ì‹

- DB ë ˆë²¨ì—ì„œ ì¡°ê±´ë¶€ UPDATE ì¿¼ë¦¬ ì‹¤í–‰
- `currentParticipants < maxParticipants` ì¡°ê±´ì„ ë§Œì¡±í•˜ëŠ” ê²½ìš°ì—ë§Œ ì¦ê°€
- ì¡°ê±´ ë¶ˆë§Œì¡± ì‹œ `updated = 0` ë°˜í™˜í•˜ì—¬ ì¸ì› ì´ˆê³¼ ì²˜ë¦¬
- ì›ìì  ì—°ì‚°ìœ¼ë¡œ Race Condition ì™„ì „ ë°©ì§€

#### DB ë ˆë²¨ ì œì•½ì¡°ê±´ ì¶”ê°€ (ì´ì¤‘ ì•ˆì „ì¥ì¹˜)

ì›ìì  UPDATE ì¿¼ë¦¬ë¡œ Race Conditionì„ í•´ê²°í–ˆì§€ë§Œ, ë°©ì–´ì  í”„ë¡œê·¸ë˜ë° ì°¨ì›ì—ì„œ DB ì œì•½ì¡°ê±´ì„ ì¶”ê°€ë¡œ ì ìš©í–ˆìŠµë‹ˆë‹¤.

**ì ìš© SQL:**
```sql
ALTER TABLE meetup 
ADD CONSTRAINT chk_participants 
CHECK (current_participants <= max_participants);
```

**íš¨ê³¼:**
- ì• í”Œë¦¬ì¼€ì´ì…˜ ë¡œì§ì„ ìš°íšŒí•˜ëŠ” ì§ì ‘ SQL ì‹¤í–‰ ì‹œì—ë„ ë°ì´í„° ë¬´ê²°ì„± ë³´ì¥
- ë‹¤ë¥¸ ì„œë¹„ìŠ¤/ë°°ì¹˜ ì‘ì—…ì—ì„œì˜ ì‹¤ìˆ˜ ë°©ì§€
- ë°ì´í„° ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹œ ì˜¤ë¥˜ ë°©ì§€
- ì˜ˆìƒì¹˜ ëª»í•œ ë²„ê·¸ë‚˜ ê²½ë¡œì—ì„œì˜ ë°ì´í„° ì˜¤ì—¼ ë°©ì§€

**ì£¼ì˜ì‚¬í•­:**
- MySQL 8.0.16 ì´ìƒì—ì„œë§Œ CHECK ì œì•½ì¡°ê±´ì´ ì ìš©ë¨
- 8.0.16 ë¯¸ë§Œ ë²„ì „ì—ì„œëŠ” ë¬¸ë²• ì˜¤ë¥˜ ì—†ì´ ë¬´ì‹œë¨

### 2.2 ì„ íƒ ì´ìœ 

#### 1. í”„ë¡œì íŠ¸ ì¼ê´€ì„± í™•ë³´ (ê°€ì¥ ì¤‘ìš”)
- **Chat ë„ë©”ì¸**: `incrementUnreadCount()` - ì›ìì  UPDATE ì¿¼ë¦¬ ì‚¬ìš©
- **User ë„ë©”ì¸**: `incrementWarningCount()` - ì›ìì  UPDATE ì¿¼ë¦¬ ì‚¬ìš©
- **Meetup ë„ë©”ì¸**: Pessimistic Lock ì‚¬ìš© â†’ **ì¼ê´€ì„± ë¶€ì¡±**
- **ê²°ì •**: í”„ë¡œì íŠ¸ ì „ë°˜ì˜ ë™ì‹œì„± ì œì–´ íŒ¨í„´ í†µì¼ í•„ìš”

#### 2. í™•ì¥ì„±
- **Pessimistic Lock**: ë™ì‹œ ì ‘ê·¼ ì‹œ ìˆœì°¨ ì²˜ë¦¬ (ë³‘ëª© ë°œìƒ)
- **ì›ìì  UPDATE ì¿¼ë¦¬**: ë³‘ë ¬ ì²˜ë¦¬ ê°€ëŠ¥ (ì„±ëŠ¥ ì €í•˜ ìµœì†Œí™”)

#### 3. DB ë ˆë²¨ ë³´ì¥
- ì¡°ê±´ë¶€ ì—…ë°ì´íŠ¸ë¡œ ì•ˆì „ì„± í™•ë³´
- Lock ëŒ€ê¸° ì‹œê°„ ì—†ìŒ

### 2.3 ë‹¤ë¥¸ í•´ê²° ë°©ë²•ë“¤ (ì°¸ê³ )

#### Pessimistic Lock
- **ì¥ì **: í™•ì‹¤í•œ ë™ì‹œì„± ì œì–´, ë¡œì»¬ DBì—ì„œ ë¹ ë¦„
- **ë‹¨ì **: í”„ë¡œì íŠ¸ ì¼ê´€ì„± ë¶€ì¡±, ìˆœì°¨ ì²˜ë¦¬ë¡œ ë³‘ëª© ê°€ëŠ¥
- **ì í•©**: ë¹ ë¥¸ ì ìš©ì´ í•„ìš”í•œ ê²½ìš° (ì„ì‹œ í•´ê²°ì±…)

#### Optimistic Lock
- **ì¥ì **: ë†’ì€ ë™ì‹œì„±, Lock ëŒ€ê¸° ì—†ìŒ
- **ë‹¨ì **: Entity ìˆ˜ì • í•„ìš”, ì¬ì‹œë„ ë¡œì§ êµ¬í˜„ í•„ìš”
- **ì í•©**: ì¶©ëŒ ë¹ˆë„ê°€ ë‚®ì„ ë•Œ

#### DB ì œì•½ì¡°ê±´
- **ì¥ì **: ìµœì¢… ì•ˆì „ì¥ì¹˜ ì—­í• 
- **ë‹¨ì **: ë‹¨ë… ì‚¬ìš© ì‹œ Race Condition ë°œìƒ ê°€ëŠ¥
- **ì í•©**: ë‹¤ë¥¸ ë°©ë²•ê³¼ í•¨ê»˜ ì´ì¤‘ ì•ˆì „ì¥ì¹˜ë¡œ í™œìš©
- **âœ… ì ìš© ì™„ë£Œ**: ì›ìì  UPDATE ì¿¼ë¦¬ì™€ í•¨ê»˜ CHECK ì œì•½ì¡°ê±´ ì ìš©

---

## 3. ê²°ê³¼

### 3.1 After (í•´ê²° í›„) ì‹œë‚˜ë¦¬ì˜¤

```
ì‹œê°„ | íŠ¸ëœì­ì…˜ A (ì‚¬ìš©ì1)              | íŠ¸ëœì­ì…˜ B (ì‚¬ìš©ì2)              | íŠ¸ëœì­ì…˜ C (ì‚¬ìš©ì3)              | DB ìƒíƒœ
-----|--------------------------------|--------------------------------|--------------------------------|----------
T1   | UPDATE ì‹¤í–‰ (ì¡°ê±´ ì²´í¬ + ì¦ê°€)   | UPDATE ì‹¤í–‰ (ì¡°ê±´ ì²´í¬ + ì¦ê°€)   | UPDATE ì‹¤í–‰ (ì¡°ê±´ ì²´í¬ + ì¦ê°€)   | 1
T2   | updated = 1 (ì„±ê³µ) âœ…           | ëŒ€ê¸° (A íŠ¸ëœì­ì…˜ ì™„ë£Œ ëŒ€ê¸°)      | ëŒ€ê¸°                              | 2
T3   | ì°¸ê°€ì ì¶”ê°€                     |                                 |                                 | 2
T4   | ì»¤ë°‹                            |                                 |                                 | 2
T5   |                                 | UPDATE ì‹¤í–‰ (ì¡°ê±´ ì²´í¬ + ì¦ê°€)   | ëŒ€ê¸°                              | 2
T6   |                                 | updated = 1 (ì„±ê³µ) âœ…           |                                 | 3
T7   |                                 | ì°¸ê°€ì ì¶”ê°€                     |                                 | 3
T8   |                                 | ì»¤ë°‹                            |                                 | 3
T9   |                                 |                                 | UPDATE ì‹¤í–‰ (ì¡°ê±´ ì²´í¬ + ì¦ê°€)   | 3
T10  |                                 |                                 | updated = 0 (ì‹¤íŒ¨) âŒ            | 3
T11  |                                 |                                 | ì˜ˆì™¸ ë°œìƒ                       | 3
ê²°ê³¼: 2ëª…ë§Œ ì°¸ê°€ ì„±ê³µ, currentParticipants = 3 (ì •ìƒ!)
```

### 3.2 Before/After ë¹„êµ

| í•­ëª© | Before (í•´ê²° ì „) | After (ì›ìì  UPDATE ì¿¼ë¦¬) |
|------|------------------|---------------------------|
| **Lost Update** | âœ… ë°œìƒ (4ëª… ì°¸ê°€, ì €ì¥ê°’ 2) | âŒ í•´ê²° (3ëª… ì°¸ê°€, ì €ì¥ê°’ 3) |
| **ì¸ì› ì´ˆê³¼** | âœ… ë°œìƒ (4ëª… > ìµœëŒ€ 3ëª…) | âŒ í•´ê²° (3ëª… = ìµœëŒ€ 3ëª…) |
| **ë°ì´í„° ì¼ì¹˜** | âŒ ë¶ˆì¼ì¹˜ (ì‹¤ì œ 4ëª… â‰  ì €ì¥ê°’ 2) | âœ… ì¼ì¹˜ (ì‹¤ì œ 3ëª… = ì €ì¥ê°’ 3) |
| **ì„±ê³µ/ì‹¤íŒ¨** | 3ëª… ì„±ê³µ, 0ëª… ì‹¤íŒ¨ (ì˜ëª»ëœ ê²°ê³¼) | 2ëª… ì„±ê³µ, 1ëª… ì‹¤íŒ¨ (ì •í™•í•œ ê²°ê³¼) |
| **ì²˜ë¦¬ ë°©ì‹** | ë™ì‹œ ì²˜ë¦¬ (Race Condition) | ë³‘ë ¬ ì²˜ë¦¬ (ì›ìì  ì¿¼ë¦¬) |
| **í”„ë¡œì íŠ¸ ì¼ê´€ì„±** | - | âœ… ìˆìŒ (Chat/Userì™€ ë™ì¼) |
| **í™•ì¥ì„±** | - | âœ… ë³‘ë ¬ ì²˜ë¦¬ ê°€ëŠ¥ |

### 3.3 ì‹¤ì œ í…ŒìŠ¤íŠ¸ ê²°ê³¼

**í…ŒìŠ¤íŠ¸ í™˜ê²½:**
- ë™ì‹œ ì°¸ê°€ ì‹œë„: 10ëª…
- í…ŒìŠ¤íŠ¸ íšŸìˆ˜: ê° ë°©ì‹ë‹¹ 5íšŒ
- ëª¨ì„ ìµœëŒ€ ì¸ì›: 3ëª…
- DB í™˜ê²½: ë¡œì»¬ DB

**Before (í•´ê²° ì „)**:
```
ì„±ê³µí•œ ì°¸ê°€: 3ëª…
ì‹¤íŒ¨í•œ ì°¸ê°€: 0ëª…
ìµœì¢… currentParticipants: 2
ì‹¤ì œ ì°¸ê°€ì ìˆ˜ (DB): 4
ìµœëŒ€ ì¸ì›: 3

âš ï¸ Race Condition ë°œìƒ í™•ì¸!
```

**After (í•´ê²° í›„)**:
```
ì„±ê³µí•œ ì°¸ê°€: 2ëª…
ì‹¤íŒ¨í•œ ì°¸ê°€: 1ëª…
ìµœì¢… currentParticipants: 3
ì‹¤ì œ ì°¸ê°€ì ìˆ˜ (DB): 3
ìµœëŒ€ ì¸ì›: 3

âœ… Race Condition í•´ê²° í™•ì¸!
```

---

## 4. ì„±ëŠ¥ ë¹„êµ

### 4.1 ì‹¤ì œ ì¸¡ì • ê²°ê³¼ (ë¡œì»¬ DB í™˜ê²½)

**âš ï¸ ì£¼ì˜: ì‹¤ì œ í…ŒìŠ¤íŠ¸ ê²°ê³¼ëŠ” í™˜ê²½ì— ë”°ë¼ ë‹¤ë¥¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.**

| í•­ëª© | Pessimistic Lock | ì›ìì  UPDATE ì¿¼ë¦¬ | ë¹„ê³  |
|------|-----------------|-------------------|------|
| **í‰ê·  ì²˜ë¦¬ ì‹œê°„** (10ëª… ë™ì‹œ) | **32.20ms** | 46.40ms | Pessimistic Lockì´ ë” ë¹ ë¦„ |
| **ìµœì†Œ ì²˜ë¦¬ ì‹œê°„** | **3ms** | 15ms | Pessimistic Lockì´ ë” ë¹ ë¦„ |
| **ìµœëŒ€ ì²˜ë¦¬ ì‹œê°„** | 103ms | **92ms** | ì›ìì  UPDATEê°€ ë” ë¹ ë¦„ |
| **ì¿¼ë¦¬ ìˆ˜** | 2ê°œ (SELECT + UPDATE) | 3ê°œ (SELECT + UPDATE + SELECT) | ì›ìì  UPDATEê°€ ë” ë§ìŒ |
| **Lock ëŒ€ê¸° ì‹œê°„** | ìˆìŒ (ë¡œì»¬ì—ì„œëŠ” ê±°ì˜ ì—†ìŒ) | ì—†ìŒ | - |
| **ë™ì‹œì„± ì•ˆì „ì„±** | âœ… ë³´ì¥ | âœ… ë³´ì¥ | ë™ì¼ |
| **í”„ë¡œì íŠ¸ ì¼ê´€ì„±** | âŒ ì—†ìŒ | âœ… ìˆìŒ | ê°œì„  |

### 4.2 ì„±ëŠ¥ ì°¨ì´ ì›ì¸ ë¶„ì„

1. **ì¿¼ë¦¬ ìˆ˜ ì°¨ì´**:
   - **Pessimistic Lock**: `findByIdWithLock` (1) + `save` (1) = **2ê°œ ì¿¼ë¦¬**
   - **ì›ìì  UPDATE ì¿¼ë¦¬**: `findById` (1) + `incrementParticipantsIfAvailable` (1) + `findById` (1, ì¬ì¡°íšŒ) = **3ê°œ ì¿¼ë¦¬**
   - ì›ìì  UPDATE ì¿¼ë¦¬ ë°©ì‹ì´ ì£¼ìµœì í™•ì¸ê³¼ ì—…ë°ì´íŠ¸ í›„ ì¬ì¡°íšŒë¡œ ì¸í•´ ì¿¼ë¦¬ê°€ ë” ë§ìŒ

2. **ë¡œì»¬ DB í™˜ê²½ íŠ¹ì„±**:
   - ë¡œì»¬ DBì—ì„œëŠ” Lock ëŒ€ê¸° ì‹œê°„ì´ ê±°ì˜ ì—†ì–´ì„œ Pessimistic Lockì˜ ë‹¨ì ì´ ë“œëŸ¬ë‚˜ì§€ ì•ŠìŒ
   - ì‹¤ì œ ìš´ì˜ í™˜ê²½(ë™ì‹œ ì ‘ê·¼ì´ ë§ì„ ë•Œ)ì—ì„œëŠ” ì›ìì  UPDATE ì¿¼ë¦¬ê°€ ë” ìœ ë¦¬í•  ìˆ˜ ìˆìŒ

3. **ë³‘ë ¬ ì²˜ë¦¬ ê°€ëŠ¥ì„±**:
   - **Pessimistic Lock**: ìˆœì°¨ ì²˜ë¦¬ (Lock ëŒ€ê¸°)
   - **ì›ìì  UPDATE ì¿¼ë¦¬**: ë³‘ë ¬ ì²˜ë¦¬ ê°€ëŠ¥ (Lock ëŒ€ê¸° ì—†ìŒ)
   - ë™ì‹œ ì ‘ê·¼ì´ ë§ì„ìˆ˜ë¡ ì›ìì  UPDATE ì¿¼ë¦¬ì˜ ì¥ì ì´ ì»¤ì§

### 4.3 ê²°ë¡ 

**ì›ìì  UPDATE ì¿¼ë¦¬ ë°©ì‹ ì„ íƒ ì´ìœ :**

1. âœ… **í”„ë¡œì íŠ¸ ì¼ê´€ì„±**: Chat, User ë„ë©”ì¸ê³¼ ë™ì¼í•œ íŒ¨í„´ (**ê°€ì¥ ì¤‘ìš”**)
2. âœ… **í™•ì¥ì„±**: ë™ì‹œ ì ‘ê·¼ì´ ë§ì„ ë•Œ ë³‘ë ¬ ì²˜ë¦¬ë¡œ ìœ ë¦¬ (Lock ëŒ€ê¸° ì—†ìŒ)
3. âœ… **ì½”ë“œ ì¼ê´€ì„±**: í”„ë¡œì íŠ¸ ì „ë°˜ì˜ ë™ì‹œì„± ì œì–´ íŒ¨í„´ í†µì¼

---

## 5. í…ŒìŠ¤íŠ¸

### 5.1 í…ŒìŠ¤íŠ¸ íŒŒì¼ ìœ„ì¹˜

`backend/test/java/com/linkup/Petory/domain/meetup/service/MeetupServiceRaceConditionTest.java`

### 5.2 í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ë°©ë²•

```bash
# Before í…ŒìŠ¤íŠ¸ (Race Condition ë°œìƒ í™•ì¸)
./gradlew test --tests MeetupServiceRaceConditionTest.testRaceConditionWithoutTransaction

# After í…ŒìŠ¤íŠ¸ (Race Condition í•´ê²° í™•ì¸)
./gradlew test --tests MeetupServiceRaceConditionTest.testRaceConditionFixedWithPessimisticLock

# ì„±ëŠ¥ ë¹„êµ í…ŒìŠ¤íŠ¸
./gradlew test --tests MeetupServiceRaceConditionTest.testPerformanceComparison

# ëª¨ë“  Race Condition í…ŒìŠ¤íŠ¸ ì‹¤í–‰
./gradlew test --tests MeetupServiceRaceConditionTest
```

---

## 6. íŠ¸ëœì­ì…˜ ê°œì„ : í•µì‹¬ ë„ë©”ì¸ê³¼ íŒŒìƒ ë„ë©”ì¸ ë¶„ë¦¬

### 6.1 ë¬¸ì œ ìƒí™©

**ìœ„ì¹˜**: `MeetupService.createMeetup()` (line 86-105)

**ì´ˆê¸° ë¬¸ì œì **:
- ëª¨ì„ ìƒì„± í›„ ì±„íŒ…ë°© ìƒì„± ì‹œë„
- ì±„íŒ…ë°© ìƒì„± ì‹¤íŒ¨ ì‹œ try-catchë¡œ ì˜ˆì™¸ë¥¼ ì¡ì•„ì„œ íŠ¸ëœì­ì…˜ì´ ë¡¤ë°±ë˜ì§€ ì•ŠìŒ
- ê²°ê³¼: ì±„íŒ…ë°© ìƒì„± ì‹¤íŒ¨í•´ë„ ëª¨ì„ë§Œ ìƒì„±ë¨ â†’ ë°ì´í„° ì¼ê´€ì„± ë¬¸ì œ

**Before (ë¬¸ì œ ì½”ë“œ)**:
```java
@Transactional
public MeetupDTO createMeetup(...) {
    Meetup savedMeetup = meetupRepository.save(meetup);
    
    // ì±„íŒ…ë°© ìƒì„± ì‹œë„
    try {
        conversationService.createConversation(...);
        conversationService.setParticipantRole(...);
    } catch (Exception e) {
        log.error("ëª¨ì„ ì±„íŒ…ë°© ìƒì„± ì‹¤íŒ¨: ...");
        // âš ï¸ ì±„íŒ…ë°© ìƒì„± ì‹¤íŒ¨í•´ë„ ëª¨ì„ ìƒì„±ì€ ì„±ê³µìœ¼ë¡œ ì²˜ë¦¬
    }
    
    return converter.toDTO(savedMeetup);
}
```

### 6.2 ì„¤ê³„ ì›ì¹™: í•µì‹¬ ë„ë©”ì¸ê³¼ íŒŒìƒ ë„ë©”ì¸ ë¶„ë¦¬

**í•µì‹¬ ê°œë…**:
- **ëª¨ì„ ìƒì„±**: í•µì‹¬ ë„ë©”ì¸ (Core Domain) - ì‚¬ìš©ìì˜ í•µì‹¬ ìš”êµ¬ì‚¬í•­
- **ì±„íŒ…ë°© ìƒì„±**: íŒŒìƒ ë„ë©”ì¸ (Supporting Domain) - ëª¨ì„ì˜ ë¶€ê°€ ê¸°ëŠ¥

**ì„¤ê³„ ì›ì¹™**:
> **íŒŒìƒ ë„ë©”ì¸ì€ ì‹¤íŒ¨í•´ë„ í•µì‹¬ ë„ë©”ì¸ì„ ë¡¤ë°±í•˜ë©´ ì•ˆ ëœë‹¤.**

**ì´ìœ **:
1. ì‚¬ìš©ì ê²½í—˜: ì±„íŒ…ë°© ë¬¸ì œë¡œ ëª¨ì„ì„ ë§Œë“¤ ìˆ˜ ì—†ìœ¼ë©´ ì‚¬ìš©ì ë¶ˆë§Œ ì¦ê°€
2. í™•ì¥ì„±: ë‹¤ë¥¸ ë¶€ê°€ ê¸°ëŠ¥ ì¶”ê°€ ì‹œ ë™ì¼í•œ ë¬¸ì œ ë°œìƒ ê°€ëŠ¥

### 6.3 í•´ê²°: ì´ë²¤íŠ¸ ê¸°ë°˜ ì•„í‚¤í…ì²˜ (Event-Driven Architecture)

**ì ìš©**: ì´ë²¤íŠ¸ ë°œí–‰ ë°©ì‹ìœ¼ë¡œ í•µì‹¬ ë„ë©”ì¸ê³¼ íŒŒìƒ ë„ë©”ì¸ ë¶„ë¦¬

**After (í•´ê²° ì½”ë“œ)**:

#### 1. ëª¨ì„ ìƒì„± (í•µì‹¬ ë„ë©”ì¸ - ë‹¨ë… íŠ¸ëœì­ì…˜)
```java
@Transactional
public MeetupDTO createMeetup(...) {
    Meetup savedMeetup = meetupRepository.save(meetup);
    
    // ëª¨ì„ ìƒì„± ì™„ë£Œ ì´ë²¤íŠ¸ ë°œí–‰ (íŠ¸ëœì­ì…˜ ì»¤ë°‹ í›„ ë¹„ë™ê¸°ë¡œ ì±„íŒ…ë°© ìƒì„± ì²˜ë¦¬)
    eventPublisher.publishEvent(new MeetupCreatedEvent(
            this,
            savedMeetup.getIdx(),
            organizer.getIdx(),
            savedMeetup.getTitle()
    ));
    
    log.info("ëª¨ì„ ìƒì„± ì™„ë£Œ: meetupIdx={}, organizer={}", savedMeetup.getIdx(), userId);
    return converter.toDTO(savedMeetup);
}
```

#### 2. ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ (íŒŒìƒ ë„ë©”ì¸ - ë³„ë„ íŠ¸ëœì­ì…˜)
```java
@Component
@RequiredArgsConstructor
public class MeetupChatRoomEventListener {
    
    private final ConversationService conversationService;
    
    @EventListener
    @Async
    @Transactional(propagation = Propagation.REQUIRES_NEW)
    public void handleMeetupCreated(MeetupCreatedEvent event) {
        try {
            // ì±„íŒ…ë°© ìƒì„± (ë³„ë„ íŠ¸ëœì­ì…˜)
            conversationService.createConversation(...);
            conversationService.setParticipantRole(...);
        } catch (Exception e) {
            // ì±„íŒ…ë°© ìƒì„± ì‹¤íŒ¨í•´ë„ ëª¨ì„ì€ ì´ë¯¸ ìƒì„±ë¨ (ë¡¤ë°±ë˜ì§€ ì•ŠìŒ)
            log.error("ëª¨ì„ ì±„íŒ…ë°© ìƒì„± ì‹¤íŒ¨: meetupIdx={}", event.getMeetupIdx(), e);
            // TODO: ì¬ì‹œë„ ë©”ì»¤ë‹ˆì¦˜ ì¶”ê°€
        }
    }
}
```

**íš¨ê³¼**:
- âœ… í•µì‹¬ ë„ë©”ì¸ ë³´ì¥: ëª¨ì„ ìƒì„±ì€ í•­ìƒ ì„±ê³µ (ì±„íŒ…ë°© ë¬¸ì œì™€ ë¬´ê´€)
- âœ… ì‚¬ìš©ì ê²½í—˜ ê°œì„ : ëª¨ì„ ìƒì„±ì€ ì¦‰ì‹œ ì„±ê³µ, ì±„íŒ…ë°©ì€ ë¹„ë™ê¸°ë¡œ ìƒì„±
- âœ… í™•ì¥ì„±: ë‹¤ë¥¸ ë¶€ê°€ ê¸°ëŠ¥ë„ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆë¡œ ì‰½ê²Œ ì¶”ê°€ ê°€ëŠ¥
- âœ… ë…ë¦½ì  ì²˜ë¦¬: ì±„íŒ…ë°© ìƒì„± ì‹¤íŒ¨ê°€ ëª¨ì„ ìƒì„±ì— ì˜í–¥ ì—†ìŒ
- âœ… ì¬ì‹œë„ ê°€ëŠ¥: ì±„íŒ…ë°© ìƒì„± ì‹¤íŒ¨ ì‹œ ë‚˜ì¤‘ì— ì¬ì‹œë„ ê°€ëŠ¥

**êµ¬í˜„ íŒŒì¼**:
- `MeetupCreatedEvent.java`: ì´ë²¤íŠ¸ í´ë˜ìŠ¤
- `MeetupChatRoomEventListener.java`: ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
- `MeetupService.java`: ì´ë²¤íŠ¸ ë°œí–‰ ë¡œì§

**ì£¼ì˜ì‚¬í•­**:
- `@EnableAsync` ì„¤ì • í•„ìš” (ì´ë¯¸ ì ìš©ë¨)
- ì±„íŒ…ë°© ìƒì„± ì‹¤íŒ¨ ì‹œ ì¬ì‹œë„ ë©”ì»¤ë‹ˆì¦˜ ê³ ë ¤ (ìŠ¤ì¼€ì¤„ëŸ¬ ë“±)

---

## 7. í•µì‹¬ í¬ì¸íŠ¸

### 7.1 ì ìš© ê°€ëŠ¥í•œ íŒ¨í„´

- **ì›ìì  UPDATE ì¿¼ë¦¬ íŒ¨í„´**: ì¡°ê±´ë¶€ ì—…ë°ì´íŠ¸ê°€ í•„ìš”í•œ ê²½ìš° (ê¶Œì¥) âœ… ì ìš©ë¨
- **Pessimistic Lock íŒ¨í„´**: ë™ì‹œ ì ‘ê·¼ì´ ë¹ˆë²ˆí•˜ê³  ë°ì´í„° ì •í•©ì„±ì´ ì¤‘ìš”í•œ ê²½ìš°
- **Optimistic Lock íŒ¨í„´**: ì¶©ëŒ ë¹ˆë„ê°€ ë‚®ê³  ì„±ëŠ¥ì´ ì¤‘ìš”í•œ ê²½ìš°
- **DB ì œì•½ì¡°ê±´ íŒ¨í„´**: ìµœì¢… ì•ˆì „ë§ìœ¼ë¡œ í•­ìƒ ì ìš© âœ… ì ìš©ë¨

### 7.2 ë¡œê¹… ì „ëµ

**ë°ì´í„° ì •í•©ì„± ë¬¸ì œì´ë¯€ë¡œ ë‹¤ìŒ ë¡œê·¸ë¥¼ ë‚¨ê¹ë‹ˆë‹¤**:

1. **ë™ì‹œì„± ê°ì§€ ë¡œê·¸**: ì°¸ê°€ ì‹œë„ ì‹œì‘ ì‹œì , ì¸ì› ì²´í¬ ì „ ìƒíƒœ
2. **Race Condition ìœ„í—˜ ê²½ê³ **: ë‚¨ì€ ìë¦¬ê°€ 1ê°œ ì´í•˜ì¼ ë•Œ ê²½ê³ 
3. **ë°ì´í„° ì •í•©ì„± ê²€ì¦ ë¡œê·¸**: `currentParticipants`ì™€ ì‹¤ì œ ì°¸ê°€ì ìˆ˜ ë¶ˆì¼ì¹˜ ê°ì§€
4. **ì„±ëŠ¥ ëª¨ë‹ˆí„°ë§ ë¡œê·¸**: ì†Œìš” ì‹œê°„ ì¸¡ì • ë° ë¡œê¹…

**ë¡œê·¸ ë ˆë²¨**:
- `INFO`: ì •ìƒ íë¦„ (ì°¸ê°€ ì‹œì‘, ì²´í¬, ì¦ê°€, ì™„ë£Œ)
- `WARN`: ì˜ˆìƒ ê°€ëŠ¥í•œ ì‹¤íŒ¨ (ì¸ì› ì´ˆê³¼, ì´ë©”ì¼ ì¸ì¦ í•„ìš” ë“±)
- `ERROR`: ë°ì´í„° ì •í•©ì„± ë¬¸ì œ (Race Condition ë°œìƒ, ë°ì´í„° ë¶ˆì¼ì¹˜)
